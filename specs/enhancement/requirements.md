# 需求文档 - 系统增强功能

## 需求概述

本次增强包含4个主要功能：申请编号优化、公告管理、通知中心、消息通知。

---

## 需求 1 - 申请编号序号化

**当前：** BK20251105xxxx（四位随机码）
**目标：** BK20251105-0001（从0001开始的序号）

### 实现方案
- 修改 `createBooking` 云函数
- 查询当天已有的申请数量
- 生成序号 = 数量 + 1
- 格式：BK + YYYYMMDD + 序号（4位，补0）

---

## 需求 2 - 公告管理系统

### 2.1 管理员端公告管理页面

**功能：**
- 轮播图管理（增删改查）
- 通知公告管理（增删改查）

**字段设计：**

**轮播图（carousel 集合）：**
- carousel_id: 轮播图ID
- title: 标题
- image_url: 图片地址
- link_url: 跳转链接（可选）
- sort_order: 排序（数字越小越靠前）
- status: 状态（0=禁用，1=启用）
- create_time, update_time, is_deleted

**通知公告（notice 集合 - 已有，需完善）：**
- notice_id: 公告ID
- title: 标题
- content: 内容
- notice_type: 类型（系统公告/排课通知）
- priority: 优先级（0=普通，1=重要）
- target_user_id: 目标用户（null=全体）
- is_read: 是否已读
- create_time, update_time, is_deleted

### 2.2 小程序端通知公告栏

**功能：**
- 首页轮播图展示
- 通知公告列表
- 点击查看详情

---

## 需求 3 - 小程序通知中心

**功能：**
- 个人消息列表（系统通知、排课结果）
- 未读消息提醒（红点）
- 标记已读
- 查看详情

**我的页面完善：**
- 显示用户信息（姓名、手机、邮箱）
- 显示统计数据（待审核、已通过、已拒绝）
- 快速跳转入口

**历史记录页面：**
- 查看已排课的课程
- 显示分配的实验室
- 显示时间段

---

## 需求 4 - 消息通知系统

### 4.1 管理员发送消息

**位置：** 申请详情对话框、排课管理详情

**功能：**
- 添加"发送消息"按钮
- 弹出输入框
- 发送后记录到 message 集合

### 4.2 自动通知

**触发时机：**
1. 拒绝申请时 → 自动通知教师
2. 自动/手动排课成功时 → 自动通知教师

**通知内容：**
- 拒绝：`您的申请 ${booking_no} 已被拒绝，原因：${remark}`
- 排课成功：`您的申请 ${booking_no} 已完成排课，实验室：${lab_name}`

---

## 云函数设计

### 新增云函数（5个）

1. **getCarouselList** - 获取轮播图列表
2. **manageCarousel** - 轮播图管理（增删改）
3. **getNoticeList** - 获取公告列表
4. **manageNotice** - 公告管理（增删改）
5. **sendMessage** - 发送消息
6. **getMyMessages** - 获取个人消息
7. **markMessageRead** - 标记消息已读
8. **getMySchedules** - 获取个人排课记录

### 修改云函数（3个）

1. **createBooking** - 修改编号生成逻辑
2. **reviewBooking** - 拒绝时自动发送消息
3. **autoSchedule/manualSchedule** - 成功时自动发送消息

---

**创建时间：** 2025-11-05

